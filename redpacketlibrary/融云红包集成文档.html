<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>融云红包集成文档</title>

</head>
<body>
<h1>融云红包集成文档</h1>

<h2>1. redpacketlibrary简介</h2>

<p><strong>redpacketlibrary</strong>，在融云<strong>sdk2.6.7state</strong>的基础上提供了收发红包和零钱页的功能。</p>

<h2>2. redpacketlibrary目录说明</h2>

<ul>
<li>libs ：</li>
<li>1、redpacket3.1.1是集成红包功能所依赖的jar包。</li>
<li>2、alipaySdk-20160516z支付宝支付</li>
<li>3、glide-3.6.1图片加载库</li>
<li>4、volley-1.0.19请求框架</li>
<li>res ：包含了红包SDK和聊天页面中的资源文件。（红包SDK相关以rp开头,融云红包消息相关以yhz开头）</li>
<li>callback ：此接口只有群/讨论组红包用到（除1之外）</li>
<li>1、GetGroupInfoCallback 获取群/讨论组里面的人数（app开发者需要自己处理）的接口回调。</li>
<li>2、ToRedPacketActivity 打开发红包界面接口回调</li>
<li>3、GetUserInfoCallback 根据用户id获取用户信息接口回调</li>
<li>4、SetUserInfoCallback 设置用户信息接口回调</li>
<li>message ：</li>
<li>1、RongRedPacketMessage 自定义红包消息。</li>
<li>2、RongNotificationMessage 自定义通知消息，用于领取了红包之后，回执消息发给红包者</li>
<li>3、RongEmptyMessage 自定义空消息，<strong>用于群/讨论组领取了红包之后，1、接受者先向本地插入一条“你领取了XX的红包”，然后发送一条空消息（不在聊天界面展示），发送红包者收到消息之后，向本地插入一条“XX领取了你的红包”，2、如果接受者和发送者是一个人就直接向本地插入一条“你领取了自己的红包”</strong></li>
<li>provider ：</li>
<li>1、RongRedPacketProvider 扩展栏单聊红包提供者</li>
<li>2、RongRedPacketMessageProvider 红包消息UI展示提供者</li>
<li>3、RongNotificationMessageProvider 回执消息UI展示提供者</li>
<li>4、RongGroupRedPacketProvider 扩展栏群聊/讨论组红包提供者</li>
<li>RedPacketUtil.java 封装了和融云红包相关的工具类。</li>
<li>RedPacketCache文件缓存类（App开发者没有需要可以删除）</li>
<li><ul>
<li><strong>注意: redpacketlibrary依赖了IMKIT，可以查看redpacketlibrary的build.gradle</strong>。</li>
</ul>
</li>
</ul>


<h2>3. 集成步骤</h2>

<h3>3.1 添加对红包工程的依赖</h3>

<ul>
<li>SealTalkDemo的build.gradle中</li>
</ul>


<pre><code>    compile fileTree(include: ['*.jar'], dir: 'libs')
    compile 'com.android.support:appcompat-v7:23.1.0'
    compile files('libs/Android_Location_V1.3.3.jar')
    compile files('libs/universal-image-loader-1.9.5.jar')
    compile files('libs/org.apache.http.legacy.jar')
    compile project(':redpacketlibrary')
</code></pre>

<ul>
<li>SealTalkDemo的setting.gradle中</li>
</ul>


<pre><code>include ':seal', ':Rong_Cloud_Android_IMKit_SDK_v2_6_7_stable_with_CallKit',  ':redpacketlibrary'
</code></pre>

<h3>3.2 SealTalkDemo清单文件中注册红包相关组件</h3>

<pre><code>
    &lt;uses-sdk
        android:minSdkVersion="9"
        android:targetSdkVersion="21"
        tools:overrideLibrary="com.yunzhanghu.redpacketui" /&gt;

    &lt;!--红包相关界面 start--&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPRedPacketActivity"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustPan|stateVisible" /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPDetailActivity"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustPan" /&gt;

        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPRecordActivity"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustPan" /&gt;

        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPWebViewActivity"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustResize|stateHidden" /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPChangeActivity"
            android:configChanges="orientation|keyboardHidden|screenSize"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustResize|stateHidden" /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPBankCardActivity"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustPan|stateHidden" /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPGroupMemberActivity"
            android:screenOrientation="portrait"
            android:windowSoftInputMode="adjustPan|stateHidden" /&gt;
        &lt;activity
            android:name="com.alipay.sdk.app.H5PayActivity"
            android:configChanges="orientation|keyboardHidden|navigation|screenSize"
            android:exported="false"
            android:screenOrientation="behind"
            android:windowSoftInputMode="adjustResize|stateHidden" /&gt;
    &lt;!--红包相关界面 end--&gt;
</code></pre>

<h3>3.3 初始化红包上下文和注册融云自定义消息类型和模板</h3>

<ul>
<li>App中初始化红包上下文和注册红包消息、回执消息类以及消息展示模板。</li>
</ul>


<pre><code>   import com.yunzhanghu.redpacketsdk.RedPacket;
   import com.yunzhanghu.redpacketui.RedPacketUtil;

    @Override
    public void onCreate() {
        /**
         * 注意：
         *
         * IMKit SDK调用第一步 初始化
         *
         * context上下文
         *
         * 只有两个进程需要初始化，主进程和 push 进程
         */
        //RongIM.setServerInfo("nav.cn.ronghub.com", "img.cn.ronghub.com");
        RongIM.init(this);

        SealAppContext.init(this);
        SharedPreferencesContext.init(this);
        Thread.setDefaultUncaughtExceptionHandler(new RongExceptionHandler(this));

        try {
            //注册红包消息、回执消息类以及消息展示模板
            RedPacketUtil.getInstance().registerMsgTypeAndTemplate(this);
            RongIM.registerMessageType(GroupNotificationMessage.class);
            RongIM.registerMessageTemplate(new ContactNotificationMessageProvider());
            RongIM.registerMessageTemplate(new RealTimeLocationMessageProvider());
            RongIM.registerMessageTemplate(new GroupNotificationMessageProvider());
            //@ 消息模板展示
            RongContext.getInstance().registerConversationTemplate(new NewDiscussionConversationProvider());
        } catch (Exception e) {
            e.printStackTrace();
        }     

           ...

        //初始化红包上下文
        RedPacket.getInstance().initContext(this, RPConstant.AUTH_METHOD_SIGN);
        RedPacket.getInstance().setDebugMode(true);
    }
</code></pre>

<ul>
<li>SealAppContext实现OnReceiveMessageListener。
<strong>App开发者可以在Application中实现</strong></li>
</ul>


<pre><code>
    private void setInputProvider() {

        RongIM.setOnReceiveMessageListener(this);//设置消息接收监听器。

    }

    @Override
    public boolean onReceived(Message message, int left) {

       MessageContent messageContent = message.getContent();
       if (messageContent instanceof RongEmptyMessage) {
            //接收到空消息（不展示UI的消息）向本地插入一条“XX领取了你的红包”
            RedPacketUtil.getInstance().insertMessage(message);
        }       

    }
</code></pre>

<h3>3.4 设置刷新红包签名和保存用户信息</h3>

<p>*MainActivity中设置刷新红包签名的方法</p>

<pre><code>
    import com.yunzhanghu.redpacketui.RedPacketUtil;

       @Override
    protected void onCreate(Bundle savedInstanceState) {
    ...
        //刷新签名
        //App开发者需要去自己服务器请求签名参数,换成自己的URl
        //@param partner      商户代码 (联系云账户后端获取)
        // @param userId       商户用户id
        // @param timestamp    签名使用的时间戳
        // @param sign         签名
        final String url = "http://rpv2.easemob.com/api/sign?duid=" + RedPacketUtil.getInstance().getUserID();
        RedPacket.getInstance().setRefreshSignListener(new RPRefreshSignListener() {
            @Override
            public void onRefreshSign(RPValueCallback&lt;TokenData&gt; rpValueCallback) {
                RedPacketUtil.getInstance().requestSign(mContext, url, rpValueCallback);
            }
        });
    }
</code></pre>

<p>*LoginActivity获取个人信息成功后保存用户信息</p>

<pre><code>
    import com.yunzhanghu.redpacketui.RedPacketUtil;

    case SYNCUSERINFO:
                    GetUserInfoByIdResponse guRes = (GetUserInfoByIdResponse) result;
                    if (guRes.getCode() == 200) {
                        e.putString("loginnickname", guRes.getResult().getNickname());
                        e.putString("loginPortrait", guRes.getResult().getPortraitUri());
                        e.commit();

                        if (TextUtils.isEmpty(guRes.getResult().getPortraitUri())) {
                            guRes.getResult().setPortraitUri(RongGenerate.generateDefaultAvatar
                                    (guRes.getResult().getNickname(), guRes.getResult().getId()));
                        }

                        //初始化用户信息
                        RedPacketUtil.getInstance().initUserInfo(guRes.getResult().getId(),
                                guRes.getResult().getNickname(), guRes.getResult().getPortraitUri());

                        RongIM.getInstance().setCurrentUserInfo(new UserInfo(guRes.getResult().getId(),
                                guRes.getResult().getNickname(), Uri.parse(guRes.getResult().getPortraitUri())));
                        RongIM.getInstance().setMessageAttachedUserInfo(true);

                        List&lt;Groups&gt; groupList = DBManager.getInstance(mContext).getDaoSession().
                                getGroupsDao().loadAll();
                        if (groupList.size() == 0 || groupList == null) {
                            request(SYNCGROUP);
                        } else {
                            LoadDialog.dismiss(mContext);
                            startActivity(new Intent(LoginActivity.this, MainActivity.class));
                            NToast.shortToast(mContext, R.string.login_success);
                            finish();
                        }
                    }
                    break;
</code></pre>

<p><strong>APP在修改用户消息的时候需要RedPacketUtil.getInstance().initUserInfo(userID, userName, userAvatar);保证信息实时统一</strong></p>

<h3>3.5 RongCloudEvent中、在扩展栏中增加红包按钮</h3>

<ul>
<li>需要导入的包</li>
</ul>


<pre><code>   import com.yunzhanghu.redpacketui.provider.RongGroupRedPacketProvider;
   import com.yunzhanghu.redpacketui.provider.RongRedPacketProvider;
   import com.yunzhanghu.redpacketui.callback.ToRedPacketActivity;
</code></pre>

<ul>
<li>添加单聊红包入口</li>
</ul>


<pre><code>
      InputProvider.ExtendProvider[] singleProvider = {
            new ImageInputProvider(RongContext.getInstance()),
            new RealTimeLocationInputProvider(RongContext.getInstance()), //带位置共享的地理位
            new RongRedPacketProvider(RongContext.getInstance())//单聊红包
        };
    RongIM.resetInputExtensionProvider(Conversation.ConversationType.PRIVATE, singleProvider); 
</code></pre>

<ul>
<li>添加群聊红包入口</li>
</ul>


<pre><code>
    InputProvider.ExtendProvider[] groupProvider = {
            new ImageInputProvider(RongContext.getInstance()),
            new LocationInputProvider(RongContext.getInstance()),//地理位置
            createGroupProvider()//群红包
        };

    //App开发者需要根据群(讨论组)ID获取群(讨论组)成员人数,
    //然后mCallback.toRedPacketActivity(number),打开发送红包界面
    private RongGroupRedPacketProvider createGroupProvider() {
        //(只是针对融云demo做的缓存逻辑,App开发者及供参考)
        RongGroupRedPacketProvider groupRedPacketProvider = new RongGroupRedPacketProvider(
        RongContext.getInstance(), new GetGroupInfoCallback() {
            @Override
            public void getGroupPersonNumber(String groupID, final ToRedPacketActivity mCallback) {

                if (RedPacketUtil.getInstance().getChatType().equals(RedPacketUtil.CHAT_GROUP)) {
                    mGroupId = groupID;
                    //同步群信息
                    AsyncTaskManager.getInstance(mContext).request(REQUEST_SYNCGROUP, SealAppContext.this);
                    int number = SharedPreferencesContext.getInstance().getSharedPreferences().getInt(groupID, 0);
                    mCallback.toRedPacketActivity(number);
                } else {//讨论组
                    mGroupId = groupID;
                    RongIM.getInstance().getDiscussion(groupID, new RongIMClient.ResultCallback&lt;Discussion&gt;() {
                        @Override
                        public void onSuccess(Discussion discussion) {
                            mIds = discussion.getMemberIdList();
                            //同步讨论组信息
                            AsyncTaskManager.getInstance(mContext).request(REQUEST_SYNCDISCUSSION, SealAppContext.this);
                            mCallback.toRedPacketActivity(discussion.getMemberIdList().size());
                        }

                        @Override
                        public void onError(RongIMClient.ErrorCode errorCode) {

                        }
                    });
                }
            }
        });
        return groupRedPacketProvider;
    }

    RongIM.resetInputExtensionProvider(Conversation.ConversationType.GROUP, groupProvider);
</code></pre>

<h3>3.6 增加专属红包（不需要可以忽略）</h3>

<p><em>在SealAppContext实现setGetUserInfoCallback和setGroupMemberListener</em></p>

<ul>
<li>需要导入的包</li>
</ul>


<pre><code>   import com.yunzhanghu.redpacketsdk.bean.RPUserBean;
   import com.yunzhanghu.redpacketui.RedPacketCache;
   import com.yunzhanghu.redpacketui.RedPacketUtil;
   import com.yunzhanghu.redpacketui.callback.GetGroupInfoCallback;
   import com.yunzhanghu.redpacketui.callback.GetUserInfoCallback;
   import com.yunzhanghu.redpacketui.callback.GroupMemberCallback;
   import com.yunzhanghu.redpacketui.callback.NotifyGroupMemberCallback;
   import com.yunzhanghu.redpacketui.callback.SetUserInfoCallback;
   import com.yunzhanghu.redpacketui.utils.RPGroupMemberUtil;
</code></pre>

<ul>
<li>实现用户信息setGetUserInfoCallback提供者</li>
</ul>


<pre><code>
      //App开发者需要根据用户ID获取用户信息,然后mCallback.setUserInfo
        RedPacketUtil.getInstance().setGetUserInfoCallback(new GetUserInfoCallback() {
            @Override
            public void getUserInfo(String userId, final SetUserInfoCallback mCallback) {
                //(只是针对融云demo做的缓存逻辑,App开发者仅供参考)
                UserInfo userInfo = RongContext.getInstance().getUserInfoFromCache(userId);
                if (userInfo != null) {
                    NLog.e("userInfo", "-user-cache-" + userInfo.getName());
                    mCallback.setUserInfo(userInfo.getName(), userInfo.getPortraitUri().toString());
                } else {
                    NLog.e("userInfo", "-user-no-cache-");
                    mUserId = userId;
                    mSetUserInfoCallback = mCallback;
                    AsyncTaskManager.getInstance(mContext).request(REQUEST_USERINFO, SealAppContext.this);
                }

            }
        });      
</code></pre>

<ul>
<li>实现群信息setGroupMemberListener提供者</li>
</ul>


<pre><code>
    //根据群(讨论组)id获取群(讨论组)成员信息,然后 groupMemberCallback.setGroupMember(list);
        RPGroupMemberUtil.getInstance().setGroupMemberListener(new NotifyGroupMemberCallback() {
            @Override
            public void getGroupMember(String groupId, GroupMemberCallback groupMemberCallback) {
                //(只是针对融云demo做的缓存逻辑,App开发者及供参考)
                if (RedPacketUtil.getInstance().getChatType().equals(RedPacketUtil.CHAT_GROUP)) {
                    ArrayList&lt;GetGroupMemberResponse.ResultEntity&gt; list = (ArrayList
                            &lt;GetGroupMemberResponse.ResultEntity&gt;) mRedPacketCache.getAsObject(groupId);
                    if (list != null) {
                        NLog.e("group_member", "-cache-");
                        groupMemberCallback.setGroupMember(sortingData(list));
                    } else {
                        NLog.e("group_member", "-no-cache-");
                        mGroupId = groupId;
                        mGroupMemberCallback = groupMemberCallback;
                        AsyncTaskManager.getInstance(mContext).request(REQUEST_GROUP_MEMBER, SealAppContext.this);
                    }
                } else {//讨论组
                    ArrayList&lt;GetUserInfosResponse.ResultEntity&gt; list = (ArrayList
                            &lt;GetUserInfosResponse.ResultEntity&gt;) mRedPacketCache.getAsObject(groupId);
                    if (list != null) {
                        NLog.e("discussion_member", "-cache-");
                        groupMemberCallback.setGroupMember(sortingDiscussionData(list));
                    } else {
                        NLog.e("discussion_member", "-no-cache-");
                        mGroupId = groupId;
                        mGroupMemberCallback = groupMemberCallback;
                        AsyncTaskManager.getInstance(mContext).request(REQUEST_DISCUSSION_MEMBER,
                                SealAppContext.this);
                    }

                }

            }
        });     
</code></pre>

<p><strong>3.6 App开发者可以在Application中实现</strong></p>

<h3>3.7 添加零钱页的入口</h3>

<ul>
<li>在需要添加零钱的页面调用下面的方法*</li>
</ul>


<pre><code>    import com.yunzhnaghu.redpacketui.RedPacketUtil;

    RedPacketUtil.getInstance().toChangeActivity(this);
</code></pre>

<p><strong>以上集成完毕、以下关于收发红包的注解</strong></p>

<h2>4. 关于群、讨论组、单聊红包收发的释义</h2>

<h3>4.1 关于红包的发送</h3>

<ul>
<li>RongRedPacketProvider中进入单聊红包界面</li>
</ul>


<pre><code>    import com.yunzhanghu.redpacketsdk.bean.RedPacketInfo;
    import com.yunzhanghu.redpacketsdk.constant.RPConstant;
    import com.yunzhanghu.redpacketui.R;
    com.yunzhnaghu.redpacketui.RedPacketUtil
    import com.yunzhanghu.redpacketui.message.RongRedPacketMessage;
    import com.yunzhanghu.redpacketui.ui.activity.RPRedPacketActivity;

    //点击扩展栏红包按钮进入发送单聊红包界面
    @Override
    public void onPluginClick(View view) {
        final Intent intent = new Intent(mContext, RPRedPacketActivity.class);
        final RedPacketInfo redPacketInfo = new RedPacketInfo();
        redPacketInfo.fromAvatarUrl = RPContext.getInstance().getUserAvatar();//发送者头像
        redPacketInfo.fromNickName = RPContext.getInstance().getUserName();//发送者名字
        redPacketInfo.toUserId = getCurrentConversation().getTargetId(); //接受者id
        redPacketInfo.chatType = RPConstant.CHATTYPE_SINGLE;//单聊

        intent.putExtra(RPConstant.EXTRA_MONEY_INFO, redPacketInfo);
        startActivityForResult(intent, RPContext.REQUEST_CODE_SEND_MONEY);
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {

      //接受返回的红包信息,并发送红包消息
      if (resultCode == Activity.RESULT_OK &amp;&amp; data != null &amp;&amp; requestCode == RPContext.REQUEST_CODE_SEND_MONEY) {
            String greeting = data.getStringExtra(RPConstant.EXTRA_MONEY_GREETING);//祝福语
            String moneyID = data.getStringExtra(RPConstant.EXTRA_CHECK_MONEY_ID);//红包ID
            String userId = RPContext.getInstance().getUserID();//发送者ID
            String userName = RPContext.getInstance().getUserName();//发送者名字
           RongRedPacketMessage message = RongRedPacketMessage.obtain(userId, userName,
                    greeting, moneyID, "1", "融云红包", "", "");    
            //发送红包消息到聊天界面
            mUploadHandler.post(new MyRunnable(message));
        }
    }

      class MyRunnable implements Runnable {

        RongRedPacketMessage mMessage;

        public MyRunnable(RongRedPacketMessage message) {
            mMessage = message;
        }

        @Override
        public void run() {
          if (RongIM.getInstance() != null &amp;&amp; RongIM.getInstance().getRongIMClient() != null) {

            RongIM.getInstance().getRongIMClient().sendMessage(getCurrentConversation().getConversationType(),
            getCurrentConversation().getTargetId(), mMessage, null, null, new RongIMClient.SendMessageCallback() {
                   @Override
                   public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                       Log.e("RedPacketProvider", "-----onError--" + errorCode);
                   }

                   @Override
                   public void onSuccess(Integer integer) {
                       Log.e("RedPacketProvider", "-----onSuccess--" + integer);
                   }
               },null);
           }

       }
    }  
</code></pre>

<ul>
<li>RongGroupRedPacketProvider中进入群红包（讨论组）界面</li>
</ul>


<pre><code>
    //点击扩展栏红包按钮进入发送群（讨论组）红包界面 
    @Override
    public void onPluginClick(View view) {

        redPacketInfo = new RedPacketInfo();
        redPacketInfo.fromAvatarUrl = RPContext.getInstance().getUserAvatar(); //发送者头像url
        redPacketInfo.fromNickName = RPContext.getInstance().getUserName();//发送者昵称 设置了昵称就传昵称 否则传id
        redPacketInfo.toGroupId = getCurrentConversation().getTargetId();//群ID
        redPacketInfo.chatType = RPConstant.CHATTYPE_GROUP;//群聊、讨论组类型
        if (callback != null) {
            callback.getGroupPersonNumber(redPacketInfo.toGroupId,this);
        } else {
            Toast.makeText(mContext, "回调函数不能为空", Toast.LENGTH_SHORT).show();
        }


    }

    @Override
    public void toRedPacketActivity(int number) {
        Intent intent = new Intent(mContext, RPRedPacketActivity.class);
        redPacketInfo.groupMemberCount = number;
        intent.putExtra(RPConstant.EXTRA_MONEY_INFO, redPacketInfo);
        intent.putExtra(RPConstant.EXTRA_AUTH_INFO, RedPacketUtil.getInstance().getAuthData());
        startActivityForResult(intent, RPContext.REQUEST_CODE_SEND_MONEY);
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {

        if (resultCode != Activity.RESULT_OK)
            return;
        //接受返回的红包信息,并发送红包消息
        if (data != null &amp;&amp; requestCode == RedPacketUtil.REQUEST_CODE_SEND_MONEY) {
            String greeting = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_GREETING);//祝福语
            String moneyID = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_ID);//红包ID
            String userId = RedPacketUtil.getInstance().getUserID();//发送者ID
            String userName = RedPacketUtil.getInstance().getUserName();//发送者名字
            String redPacketType = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_TYPE);//群红包类型
            String specialReceiveId = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_RECEIVER_ID);//专属红包接受者ID
            RongRedPacketMessage message = RongRedPacketMessage.obtain(userId, userName, 
                    greeting, moneyID, "1", "融云红包", redPacketType, specialReceiveId);
            //发送红包消息到聊天界面
            mUploadHandler.post(new MyRunnable(message));
        }
        super.onActivityResult(requestCode, resultCode, data);
    }

    class MyRunnable implements Runnable {

        RongRedPacketMessage mMessage;

        public MyRunnable(RongRedPacketMessage message) {
            mMessage = message;
        }

        @Override
        public void run() {
            if (RongIM.getInstance() != null &amp;&amp; RongIM.getInstance().getRongIMClient() != null) {            

       RongIM.getInstance().getRongIMClient().sendMessage(getCurrentConversation().getConversationType(),
       getCurrentConversation().getTargetId() , mMessage, null, null, new RongIMClient.SendMessageCallback() {
                    @Override
                    public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                        Log.e("PacketProvider", "-----onError--" + errorCode);
                    }

                    @Override
                    public void onSuccess(Integer integer) {
                        Log.e("PacketProvider", "-----onSuccess--" + integer);
                    }
                },null);
            }

        }
    }    
</code></pre>

<h3>4.2 RongRedPacketMessageProvider中打开红包消息和回执消息处理</h3>

<ul>
<li>接受红包消息打开红包</li>
</ul>


<pre><code>
    @Override
    public void onItemClick(View view, int position, final RongRedPacketMessage content, final UIMessage message) {
        mContent = content;
        mMessage = message;
        progressDialog = new ProgressDialog(mContext);
        //进度条风格开发者可以根据需求改变
        progressDialog.setProgressStyle(ProgressDialog.STYLE_SPINNER);
        progressDialog.setCanceledOnTouchOutside(false);
        //以下是打开红包所需要的参数
        redPacketInfo = new RedPacketInfo();
        redPacketInfo.moneyID = content.getMoneyID();//获取红包id
        redPacketInfo.toAvatarUrl = RedPacketUtil.getInstance().getUserAvatar();//获取打开红包者的名字
        redPacketInfo.toNickName = RedPacketUtil.getInstance().getUserName();//获取打开红包者的头像
        //判断发送方还是接收方
        if (message.getMessageDirection() == UIMessage.MessageDirection.SEND) {
            redPacketInfo.moneyMsgDirect = RPConstant.MESSAGE_DIRECT_SEND;//发送者
        } else {
            redPacketInfo.moneyMsgDirect = RPConstant.MESSAGE_DIRECT_RECEIVE;//接受方
        }
        //获取聊天类型
        if (message.getConversationType() == Conversation.ConversationType.PRIVATE) {//单聊
            redPacketInfo.chatType = RPConstant.CHATTYPE_SINGLE;

        } else {//群聊
            redPacketInfo.chatType = RPConstant.CHATTYPE_GROUP;
        }
        String redPacketType = content.getRedPacketType();
        //专属红包需要根据用户id获取用户信息
        if (!TextUtils.isEmpty(redPacketType) &amp;&amp; redPacketType.
                equals(RPConstant.GROUP_RED_PACKET_TYPE_EXCLUSIVE)) {
            String specialReceiveId = content.getSpecialReceivedID();
            progressDialog.show();
            RedPacketUtil.getInstance().getGetUserInfoCallback().getUserInfo(specialReceiveId, this);
        } else {
            openRedPacket(false);
        }
    }  

    public void openRedPacket(final boolean isSpecial) {
        //打开红包
        RPOpenPacketUtil.getInstance().openRedPacket(redPacketInfo,
                RedPacketUtil.getInstance().getAuthData(), (FragmentActivity) mContext, 
                new RPOpenPacketUtil.RPOpenPacketCallBack() {
            @Override
            public void onSuccess(String s, String s1) {
                //打开红包消息成功,然后发送回执消息例如"你领取了XX的红包"
                sendAckMsg(mContent, mMessage, RedPacketUtil.getInstance().getUserName());
            }

            @Override
            public void showLoading() {
                if (!isSpecial) {
                    progressDialog.show();
                }

            }

            @Override
            public void hideLoading() {
                progressDialog.dismiss();
            }

            @Override
            public void onError(String errorCode, String errorMsg) {
                //错误处理
                Toast.makeText(mContext, errorMsg, Toast.LENGTH_SHORT).show();
            }
        });
    }

    @Override
    public void setUserInfo(String userName, String userAvatar) {
        redPacketInfo.toUserId = RedPacketUtil.getInstance().getUserID();
        redPacketInfo.specialNickname = userName;
        redPacketInfo.specialAvatarUrl = userAvatar;
        openRedPacket(true);
    }  
</code></pre>

<ul>
<li>接受红包消息之后回执消息的处理</li>
</ul>


<pre><code>
     public void sendAckMsg(RongRedPacketMessage content, UIMessage message, String receiveName) {
        String receiveID = RPContext.getInstance().getUserID();
        RongNotificationMessage rongNotificationMessage = RongNotificationMessage.obtain(content.getSendUserID(), 
                content.getSendUserName(), receiveID, receiveName, "1");//回执消息
        final RongEmptyMessage rongEmptyMessage = RongEmptyMessage.obtain(content.getSendUserID(),
                content.getSendUserName(), receiveID, receiveName, "1");//空消息
        if (message.getConversationType() == Conversation.ConversationType.PRIVATE) {//单聊
            RongIM.getInstance().getRongIMClient().sendMessage(message.getConversationType(), 
            content.getSendUserID(), rongNotificationMessage, null, null, new RongIMClient.SendMessageCallback() {
                @Override
                public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                    Log.e("yzh", "-单聊发送回执消息失败-");

                }

                @Override
                public void onSuccess(Integer integer) {

                    Log.e("yzh", "-单聊发送回执消息成功-");
                }
            }, null);
        } else {//群聊讨论组
            if (content.getSendUserID().equals(receiveID)) {//自己领取了自己的红包
                RongIM.getInstance().getRongIMClient().insertMessage(message.getConversationType(),
                        message.getTargetId(), receiveID, rongNotificationMessage, null);
            } else {
                RongIM.getInstance().getRongIMClient().sendMessage(message.getConversationType(),
                message.getTargetId(), rongEmptyMessage, null, null, new RongIMClient.SendMessageCallback() {
                    @Override
                    public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                        Log.e("yzh", "-发送空消息通知类失败-");

                    }

                    @Override
                    public void onSuccess(Integer integer) {

                        Log.e("yzh", "-发送空消息通知类成功-");
                    }
                }, null);
                RongIM.getInstance().getRongIMClient().insertMessage(message.getConversationType(),
                        message.getTargetId(), receiveID, rongNotificationMessage, null);
            }
        }
    }
</code></pre>

<ul>
<li>红包消息删除处理</li>
</ul>


<pre><code>
    @Override
    public void onItemLongClick(View view, int position, RongRedPacketMessage content, final UIMessage message) {

        String[] items;
        items = new String[]{view.getContext().getResources().getString(R.string.yzh_dialog_item_delete)};
        ArraysDialogFragment.newInstance("", items).setArraysDialogItemListener(
                new ArraysDialogFragment.OnArraysDialogItemListener() {
            @Override
            public void OnArraysDialogItemClick(DialogInterface dialog, int which) {
                if (which == 0)
                RongIM.getInstance().getRongIMClient().deleteMessages(new int[]{message.getMessageId()}, null);

            }
        }).show(((FragmentActivity) view.getContext()).getSupportFragmentManager());
    }
</code></pre>
</body>
</html>